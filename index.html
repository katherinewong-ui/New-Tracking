<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>家庭健康管理</title>
<script src="https://cdn.tailwindcss.com"></script>
<!-- 添加Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script>
tailwind.config = {
theme: {
extend: {
colors: {
primary: '#FFB26B',
secondary: '#FFD4D4',
background: '#FDFBF7',
textPrimary: '#4A4A4A'
},
borderRadius: {
'none': '0px',
'sm': '2px',
DEFAULT: '4px',
'md': '8px',
'lg': '12px',
'xl': '16px',
'2xl': '20px',
'3xl': '24px',
'full': '9999px',
'button': '4px'
}
}
}
}
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
<style>
body {
min-height: 1024px;
background-color: #FDFBF7;
color: #4A4A4A;
}
input:focus {
outline: none;
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}
.modal {
display: none;
position: fixed;
z-index: 100;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.4);
}
.modal-content {
background-color: #fefefe;
margin: 10% auto;
padding: 20px;
border: 1px solid #888;
width: 80%;
max-width: 500px;
border-radius: 12px;
}
.close {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
cursor: pointer;
}
.loading {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid rgba(255,178,107,.3);
border-radius: 50%;
border-top-color: #FFB26B;
animation: spin 1s ease-in-out infinite;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
</style>
</head>
<body>
<header class="bg-white shadow-sm fixed w-full z-50">
<div class="max-w-7xl mx-auto px-4">
<div class="flex items-center justify-between h-16">
<div class="flex items-center">
<span class="text-2xl font-['Pacifico'] text-primary">家庭健康</span>
</div>
<nav class="flex space-x-8">
<a href="#location" class="text-textPrimary hover:text-primary px-3 py-2 font-medium">位置记录</a>
<a href="#glucose" class="text-textPrimary hover:text-primary px-3 py-2 font-medium">血糖监测</a>
<a href="#weight" class="text-textPrimary hover:text-primary px-3 py-2 font-medium">体重记录</a>
</nav>
</div>
</div>
</header>
<main class="pt-16">
<!-- 添加连接状态指示器 -->
<div id="connectionStatus" class="fixed top-16 right-4 z-50 bg-white shadow-md rounded-lg p-2 hidden">
<span class="text-sm flex items-center">
<i class="fas fa-wifi mr-2 text-green-500 connected-icon"></i>
<i class="fas fa-wifi-slash mr-2 text-red-500 disconnected-icon hidden"></i>
<span class="status-text">已连接</span>
</span>
</div>

<section id="location" class="py-12">
<div class="max-w-7xl mx-auto px-4">
<h2 class="text-2xl font-bold mb-8">Dad's Location Tracking</h2>
<div class="bg-white rounded-lg shadow-sm p-6">
<div class="flex items-center justify-between mb-6">
<div class="flex space-x-4">
<button id="addLocationBtn" class="bg-primary text-white px-4 py-2 !rounded-button hover:bg-opacity-90 whitespace-nowrap">
<i class="fas fa-plus mr-2"></i>添加记录
</button>
<input type="date" id="locationDate" class="border border-primary px-4 py-2 !rounded-button">
</div>
</div>
<div class="h-[300px] w-full bg-cover bg-center rounded-lg overflow-hidden mb-6" style="background-image: url('https://ai-public.mastergo.com/gen_page/map_placeholder_1280x720.png')"></div>
<div class="space-y-4">
<div class="flex items-center justify-between p-4 bg-background rounded-lg">
<div>
<p class="text-sm text-gray-500">今日位置</p>
<p id="currentLocation" class="font-medium">暂无记录</p>
<p class="text-sm text-primary mt-1" id="locationDuration">停留时间：0 天</p>
</div>
<button class="text-primary hover:text-opacity-80">
<i class="fas fa-map-marker-alt text-xl"></i>
</button>
</div>
<div class="divide-y divide-gray-100">
<div class="py-4">
<h3 class="font-medium mb-4">位置记录</h3>
<div id="locationHistory" class="space-y-4">
<!-- 位置记录将动态添加到这里 -->
<p class="text-gray-500 text-center py-4">暂无历史记录</p>
</div>
</div>
</div>
<!-- 地点停留统计部分 -->
<div class="mt-8">
<h3 class="font-medium mb-4">地点停留统计</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
<div id="locationStatsChart" class="h-64"></div>
<div id="locationStatsList" class="flex flex-col justify-center">
<p class="text-gray-500 text-center">暂无统计数据</p>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="glucose" class="py-12 bg-white">
<div class="max-w-7xl mx-auto px-4">
<h2 class="text-2xl font-bold mb-8">血糖监测</h2>
<div class="bg-background rounded-lg shadow-sm p-6">
<div class="flex items-center justify-between mb-6">
<div class="flex space-x-4">
<button id="addGlucoseBtn" class="bg-primary text-white px-4 py-2 !rounded-button hover:bg-opacity-90 whitespace-nowrap">
<i class="fas fa-plus mr-2"></i>添加记录
</button>
<input type="date" id="glucoseDate" class="border border-primary px-4 py-2 !rounded-button">
</div>
</div>
<div id="glucoseChart" class="h-[400px]"></div>
</div>
</div>
</section>
<section id="weight" class="py-12">
<div class="max-w-7xl mx-auto px-4">
<h2 class="text-2xl font-bold mb-8">家庭体重记录</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="bg-white rounded-lg shadow-sm p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="font-medium">爸爸</h3>
<button class="text-primary hover:text-opacity-80 edit-weight" data-member="dad">
<i class="fas fa-edit"></i>
</button>
</div>
<div class="text-3xl font-bold text-primary" id="dadWeight">-- <span class="text-sm text-gray-500">kg</span></div>
<div class="text-sm text-gray-500 mt-2" id="dadWeightDate">上次更新：暂无记录</div>
</div>
<div class="bg-white rounded-lg shadow-sm p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="font-medium">妈妈</h3>
<button class="text-primary hover:text-opacity-80 edit-weight" data-member="mom">
<i class="fas fa-edit"></i>
</button>
</div>
<div class="text-3xl font-bold text-primary" id="momWeight">-- <span class="text-sm text-gray-500">kg</span></div>
<div class="text-sm text-gray-500 mt-2" id="momWeightDate">上次更新：暂无记录</div>
</div>
<div class="bg-white rounded-lg shadow-sm p-6">
<div class="flex justify-between items-center mb-4">
<h3 class="font-medium">我</h3>
<button class="text-primary hover:text-opacity-80 edit-weight" data-member="me">
<i class="fas fa-edit"></i>
</button>
</div>
<div class="text-3xl font-bold text-primary" id="meWeight">-- <span class="text-sm text-gray-500">kg</span></div>
<div class="text-sm text-gray-500 mt-2" id="meWeightDate">上次更新：暂无记录</div>
</div>
</div>
<div class="mt-8 bg-white rounded-lg shadow-sm p-6">
<div id="weightChart" class="h-[400px]"></div>
</div>
</div>
</section>
</main>

<!-- 添加位置模态框 -->
<div id="locationModal" class="modal">
<div class="modal-content">
<span class="close">&times;</span>
<h2 class="text-xl font-bold mb-4">添加位置记录</h2>
<form id="locationForm">
<div class="mb-4">
<label class="block text-gray-700 mb-2">日期</label>
<input type="date" id="modalLocationDate" class="w-full border border-gray-300 px-3 py-2 rounded" required>
</div>
<div class="mb-4">
<label class="block text-gray-700 mb-2">位置</label>
<input type="text" id="modalLocation" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="请输入位置" required>
</div>
<button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90">
<span id="locationSubmitText">保存</span>
<span id="locationLoading" class="loading hidden ml-2"></span>
</button>
</form>
</div>
</div>

<!-- 添加血糖模态框 -->
<div id="glucoseModal" class="modal">
<div class="modal-content">
<span class="close">&times;</span>
<h2 class="text-xl font-bold mb-4">添加血糖记录</h2>
<form id="glucoseForm">
<div class="mb-4">
<label class="block text-gray-700 mb-2">日期</label>
<input type="date" id="modalGlucoseDate" class="w-full border border-gray-300 px-3 py-2 rounded" required>
</div>
<div class="grid grid-cols-2 gap-4 mb-4">
<div>
<label class="block text-gray-700 mb-2">空腹血糖</label>
<input type="number" step="0.1" id="fastingGlucose" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="mmol/L">
</div>
<div>
<label class="block text-gray-700 mb-2">早餐前</label>
<input type="number" step="0.1" id="beforeBreakfast" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="mmol/L">
</div>
<div>
<label class="block text-gray-700 mb-2">早餐后2h</label>
<input type="number" step="0.1" id="afterBreakfast" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="mmol/L">
</div>
<div>
<label class="block text-gray-700 mb-2">午餐前</label>
<input type="number" step="0.1" id="beforeLunch" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="mmol/L">
</div>
<div>
<label class="block text-gray-700 mb-2">午餐后2h</label>
<input type="number" step="0.1" id="afterLunch" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="mmol/L">
</div>
<div>
<label class="block text-gray-700 mb-2">晚餐前</label>
<input type="number" step="0.1" id="beforeDinner" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="mmol/L">
</div>
<div>
<label class="block text-gray-700 mb-2">晚餐后2h</label>
<input type="number" step="0.1" id="afterDinner" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="mmol/L">
</div>
</div>
<button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90">
<span id="glucoseSubmitText">保存</span>
<span id="glucoseLoading" class="loading hidden ml-2"></span>
</button>
</form>
</div>
</div>

<!-- 添加体重模态框 -->
<div id="weightModal" class="modal">
<div class="modal-content">
<span class="close">&times;</span>
<h2 class="text-xl font-bold mb-4">添加体重记录</h2>
<form id="weightForm">
<div class="mb-4">
<label class="block text-gray-700 mb-2">家庭成员</label>
<select id="modalWeightMember" class="w-full border border-gray-300 px-3 py-2 rounded" required>
<option value="dad">爸爸</option>
<option value="mom">妈妈</option>
<option value="me">我</option>
</select>
</div>
<div class="mb-4">
<label class="block text-gray-700 mb-2">日期</label>
<input type="date" id="modalWeightDate" class="w-full border border-gray-300 px-3 py-2 rounded" required>
</div>
<div class="mb-4">
<label class="block text-gray-700 mb-2">体重 (kg)</label>
<input type="number" step="0.1" id="modalWeight" class="w-full border border-gray-300 px-3 py-2 rounded" placeholder="请输入体重" required>
</div>
<button type="submit" class="bg-primary text-white px-4 py-2 rounded hover:bg-opacity-90">
<span id="weightSubmitText">保存</span>
<span id="weightLoading" class="loading hidden ml-2"></span>
</button>
</form>
</div>
</div>

<script>
// Firebase配置 - 您需要替换为自己的配置
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "your-project-id.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project-id.appspot.com",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// 初始化Firebase
try {
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  
  // 更新连接状态
  firebase.firestore().enableNetwork()
    .then(() => {
      showConnectionStatus(true);
    });
  
  // 监听连接状态
  firebase.firestore().onSnapshotsInSync(() => {
    showConnectionStatus(true);
  });
  
  // 监听网络状态变化
  firebase.firestore().waitForPendingWrites().then(() => {
    showConnectionStatus(true);
  }).catch(() => {
    showConnectionStatus(false);
  });
} catch (e) {
  console.error("Firebase初始化错误:", e);
  showConnectionStatus(false);
}

// 显示连接状态
function showConnectionStatus(connected) {
  const statusElement = document.getElementById('connectionStatus');
  const statusText = statusElement.querySelector('.status-text');
  const connectedIcon = statusElement.querySelector('.connected-icon');
  const disconnectedIcon = statusElement.querySelector('.disconnected-icon');
  
  statusElement.classList.remove('hidden');
  
  if (connected) {
    statusText.textContent = '已连接';
    connectedIcon.classList.remove('hidden');
    disconnectedIcon.classList.add('hidden');
    statusElement.classList.remove('bg-red-100', 'text-red-800');
    statusElement.classList.add('bg-green-100', 'text-green-800');
  } else {
    statusText.textContent = '离线模式';
    connectedIcon.classList.add('hidden');
    disconnectedIcon.classList.remove('hidden');
    statusElement.classList.remove('bg-green-100', 'text-green-800');
    statusElement.classList.add('bg-red-100', 'text-red-800');
  }
  
  // 5秒后隐藏状态提示
  setTimeout(() => {
    statusElement.classList.add('hidden');
  }, 5000);
}

// 初始化图表
const glucoseChart = echarts.init(document.getElementById('glucoseChart'));
const weightChart = echarts.init(document.getElementById('weightChart'));
const locationStatsChart = echarts.init(document.getElementById('locationStatsChart'));

// 数据存储
let healthData = {
  location: {},
  glucose: {},
  weight: {}
};

// 从Firestore加载数据
function loadData() {
  // 显示加载状态
  showLoadingState(true);
  
  // 获取位置数据
  db.collection("locations").orderBy("date", "desc").get()
    .then((querySnapshot) => {
      healthData.location = {};
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        healthData.location[data.date] = data.location;
      });
      updateLocationUI();
      updateLocationStatsUI();
    })
    .catch((error) => {
      console.error("获取位置数据错误:", error);
      showConnectionStatus(false);
    });
  
  // 获取血糖数据
  db.collection("glucose").orderBy("date", "asc").get()
    .then((querySnapshot) => {
      healthData.glucose = {};
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        healthData.glucose[data.date] = {
          fasting: data.fasting || null,
          beforeBreakfast: data.beforeBreakfast || null,
          afterBreakfast: data.afterBreakfast || null,
          beforeLunch: data.beforeLunch || null,
          afterLunch: data.afterLunch || null,
          beforeDinner: data.beforeDinner || null,
          afterDinner: data.afterDinner || null
        };
      });
      updateGlucoseUI();
    })
    .catch((error) => {
      console.error("获取血糖数据错误:", error);
      showConnectionStatus(false);
    });
  
  // 获取体重数据
  db.collection("weights").get()
    .then((querySnapshot) => {
      healthData.weight = { dad: {}, mom: {}, me: {} };
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (!healthData.weight[data.member]) healthData.weight[data.member] = {};
        healthData.weight[data.member][data.date] = data.weight;
      });
      updateWeightUI();
      showLoadingState(false);
    })
    .catch((error) => {
      console.error("获取体重数据错误:", error);
      showConnectionStatus(false);
      showLoadingState(false);
    });
  
  // 设置实时监听
  setupRealtimeListeners();
}

// 设置实时监听
function setupRealtimeListeners() {
  // 监听位置数据变化
  db.collection("locations").orderBy("date", "desc")
    .onSnapshot((querySnapshot) => {
      healthData.location = {};
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        healthData.location[data.date] = data.location;
      });
      updateLocationUI();
      updateLocationStatsUI();
    });
  
  // 监听血糖数据变化
  db.collection("glucose").orderBy("date", "asc")
    .onSnapshot((querySnapshot) => {
      healthData.glucose = {};
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        healthData.glucose[data.date] = {
          fasting: data.fasting || null,
          beforeBreakfast: data.beforeBreakfast || null,
          afterBreakfast: data.afterBreakfast || null,
          beforeLunch: data.beforeLunch || null,
          afterLunch: data.afterLunch || null,
          beforeDinner: data.beforeDinner || null,
          afterDinner: data.afterDinner || null
        };
      });
      updateGlucoseUI();
    });
  
  // 监听体重数据变化
  db.collection("weights")
    .onSnapshot((querySnapshot) => {
      healthData.weight = { dad: {}, mom: {}, me: {} };
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (!healthData.weight[data.member]) healthData.weight[data.member] = {};
        healthData.weight[data.member][data.date] = data.weight;
      });
      updateWeightUI();
    });
}

// 显示/隐藏加载状态
function showLoadingState(show) {
  const loadingElements = document.querySelectorAll('.loading-state');
  loadingElements.forEach(el => {
    if (show) {
      el.classList.remove('hidden');
    } else {
      el.classList.add('hidden');
    }
  });
}

// 更新UI显示
function updateUI() {
  updateLocationUI();
  updateGlucoseUI();
  updateWeightUI();
  updateLocationStatsUI();
}

// 更新位置UI
function updateLocationUI() {
  const today = new Date().toISOString().split('T')[0];
  const locationHistory = document.getElementById('locationHistory');
  const currentLocation = document.getElementById('currentLocation');
  const locationDuration = document.getElementById('locationDuration');
  
  // 清空历史记录
  locationHistory.innerHTML = '';
  
  // 获取所有位置记录并按日期排序
  const locations = Object.entries(healthData.location || {})
    .sort((a, b) => new Date(b[0]) - new Date(a[0]));
  
  if (locations.length === 0) {
    locationHistory.innerHTML = '<p class="text-gray-500 text-center py-4">暂无历史记录</p>';
    currentLocation.textContent = '暂无记录';
    locationDuration.textContent = '停留时间：0 天';
    return;
  }
  
  // 显示最新位置
  const [latestDate, latestLocation] = locations[0];
  currentLocation.textContent = latestLocation;
  
  // 计算停留时间（从记录日期到今天）
  const stayDays = Math.floor((new Date() - new Date(latestDate)) / (1000 * 60 * 60 * 24)) + 1;
  locationDuration.textContent = `停留时间：${stayDays} 天`;
  
  // 显示历史记录
  locations.forEach(([date, location], index) => {
    // 计算每个地点的停留天数
    let stayDaysForLocation = 1;
    if (index < locations.length - 1) {
      const nextDate = new Date(locations[index + 1][0]);
      const currentDate = new Date(date);
      stayDaysForLocation = Math.floor((nextDate - currentDate) / (1000 * 60 * 60 * 24));
    } else {
      // 第一条记录（最新记录）的停留天数已经计算过了
      stayDaysForLocation = stayDays;
    }
    
    const locationElement = document.createElement('div');
    locationElement.className = 'flex items-center justify-between';
    locationElement.innerHTML = `
      <div>
        <p class="font-medium">${location}</p>
        <p class="text-sm text-gray-500">${date} (停留${stayDaysForLocation}天)</p>
      </div>
      <button class="text-red-500 hover:text-opacity-80 delete-location" data-date="${date}">
        <i class="fas fa-trash"></i>
      </button>
    `;
    locationHistory.appendChild(locationElement);
  });
  
  // 添加删除事件监听
  document.querySelectorAll('.delete-location').forEach(button => {
    button.addEventListener('click', function() {
      const date = this.getAttribute('data-date');
      
      // 从Firestore删除
      db.collection("locations").where("date", "==", date).get()
        .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            doc.ref.delete();
          });
        })
        .catch((error) => {
          console.error("删除位置记录错误:", error);
          showConnectionStatus(false);
        });
    });
  });
}

// 更新地点停留统计UI
function updateLocationStatsUI() {
  const locationStatsList = document.getElementById('locationStatsList');
  const locationData = healthData.location || {};
  
  // 计算每个地点的停留天数
  const locationStats = {};
  const sortedDates = Object.keys(locationData).sort();
  
  if (sortedDates.length === 0) {
    locationStatsList.innerHTML = '<p class="text-gray-500 text-center">暂无统计数据</p>';
    locationStatsChart.setOption({
      title: {
        text: '暂无位置数据',
        left: 'center',
        top: 'center',
        textStyle: {
          color: '#999',
          fontSize: 14,
          fontWeight: 'normal'
        }
      },
      series: []
    });
    return;
  }
  
  // 计算每个地点的停留天数
  for (let i = 0; i < sortedDates.length; i++) {
    const currentDate = sortedDates[i];
    const currentLocation = locationData[currentDate];
    
    let daysAtLocation;
    if (i < sortedDates.length - 1) {
      // 计算从当前记录日期到下一条记录日期之间的天数
      const nextDate = new Date(sortedDates[i + 1]);
      const currDate = new Date(currentDate);
      daysAtLocation = Math.floor((nextDate - currDate) / (1000 * 60 * 60 * 24));
    } else {
      // 最后一条记录：从记录日期到今天的天数
      const currDate = new Date(currentDate);
      const today = new Date();
      daysAtLocation = Math.floor((today - currDate) / (1000 * 60 * 60 * 24)) + 1;
    }
    
    if (!locationStats[currentLocation]) {
      locationStats[currentLocation] = 0;
    }
    locationStats[currentLocation] += daysAtLocation;
  }
  
  // 计算总天数和百分比
  const totalDays = Object.values(locationStats).reduce((sum, days) => sum + days, 0);
  
  // 准备图表数据
  const chartData = [];
  const statsListItems = [];
  
  Object.entries(locationStats)
    .sort((a, b) => b[1] - a[1]) // 按天数降序排序
    .forEach(([location, days]) => {
      const percentage = ((days / totalDays) * 100).toFixed(1);
      
      // 图表数据
      chartData.push({
        value: days,
        name: location
      });
      
      // 统计列表项
      statsListItems.push(`
        <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
          <span class="font-medium">${location}</span>
          <span class="text-primary">${percentage}% (${days}天)</span>
        </div>
      `);
    });
  
  // 更新统计列表
  locationStatsList.innerHTML = statsListItems.join('');
  
  // 更新统计图表
  const option = {
    tooltip: {
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c}天 ({d}%)'
    },
    legend: {
      orient: 'vertical',
      right: 10,
      top: 'center',
      formatter: function(name) {
        const data = chartData.find(item => item.name === name);
        return `${name}: ${data.value}天`;
      }
    },
    series: [
      {
        name: '地点停留',
        type: 'pie',
        radius: ['40%', '70%'],
        avoidLabelOverlap: false,
        itemStyle: {
          borderRadius: 10,
          borderColor: '#fff',
          borderWidth: 2
        },
        label: {
          show: false,
          position: 'center'
        },
        emphasis: {
          label: {
            show: true,
            fontSize: 14,
            fontWeight: 'bold'
          }
        },
        labelLine: {
          show: false
        },
        data: chartData
      }
    ]
  };
  
  locationStatsChart.setOption(option);
}

// 更新血糖UI
function updateGlucoseUI() {
  const glucoseData = healthData.glucose || {};
  const dates = Object.keys(glucoseData).sort();
  
  if (dates.length === 0) {
    glucoseChart.setOption({
      title: {
        text: '暂无血糖数据',
        left: 'center',
        top: 'center',
        textStyle: {
          color: '#999',
          fontSize: 16,
          fontWeight: 'normal'
        }
      },
      xAxis: {
        show: false
      },
      yAxis: {
        show: false
      },
      series: []
    });
    return;
  }
  
  const fastingData = [];
  const beforeMealData = [];
  const afterMealData = [];
  
  dates.forEach(date => {
    const data = glucoseData[date];
    fastingData.push(data.fasting || null);
    
    // 计算餐前平均值
    const beforeMealValues = [data.beforeBreakfast, data.beforeLunch, data.beforeDinner].filter(v => v);
    beforeMealData.push(beforeMealValues.length ? 
      (beforeMealValues.reduce((a, b) => a + b, 0) / beforeMealValues.length) : null);
    
    // 计算餐后平均值
    const afterMealValues = [data.afterBreakfast, data.afterLunch, data.afterDinner].filter(v => v);
    afterMealData.push(afterMealValues.length ? 
      (afterMealValues.reduce((a, b) => a + b, 0) / afterMealValues.length) : null);
  });
  
  const option = {
    animation: false,
    tooltip: {
      trigger: 'axis'
    },
    legend: {
      data: ['空腹血糖', '餐前血糖', '餐后血糖']
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: dates.map(d => d.substring(5)) // 显示月-日
    },
    yAxis: {
      type: 'value',
      name: '血糖值 (mmol/L)'
    },
    series: [
      {
        name: '空腹血糖',
        type: 'line',
        data: fastingData,
        itemStyle: {
          color: '#FFB26B'
        }
      },
      {
        name: '餐前血糖',
        type: 'line',
        data: beforeMealData,
        itemStyle: {
          color: '#FFD4D4'
        }
      },
      {
        name: '餐后血糖',
        type: 'line',
        data: afterMealData,
        itemStyle: {
          color: '#4A4A4A'
        }
      }
    ]
  };
  
  glucoseChart.setOption(option);
}

// 更新体重UI
function updateWeightUI() {
  const weightData = healthData.weight || {};
  
  // 更新最新体重显示
  ['dad', 'mom', 'me'].forEach(member => {
    const memberData = weightData[member];
    if (memberData && Object.keys(memberData).length > 0) {
      const latestDate = Object.keys(memberData).sort().pop();
      const weight = memberData[latestDate];
      document.getElementById(`${member}Weight`).textContent = weight;
      document.getElementById(`${member}WeightDate`).textContent = `上次更新：${latestDate}`;
    } else {
      document.getElementById(`${member}Weight`).textContent = '--';
      document.getElementById(`${member}WeightDate`).textContent = '上次更新：暂无记录';
    }
  });
  
  // 更新体重图表
  const allDates = new Set();
  Object.values(weightData).forEach(memberData => {
    Object.keys(memberData).forEach(date => allDates.add(date));
  });
  
  const sortedDates = Array.from(allDates).sort();
  if (sortedDates.length === 0) {
    weightChart.setOption({
      title: {
        text: '暂无体重数据',
        left: 'center',
        top: 'center',
        textStyle: {
          color: '#999',
          fontSize: 16,
          fontWeight: 'normal'
        }
      },
      xAxis: {
        show: false
      },
      yAxis: {
        show: false
      },
      series: []
    });
    return;
  }
  
  const dadData = [];
  const momData = [];
  const meData = [];
  
  sortedDates.forEach(date => {
    dadData.push(weightData.dad && weightData.dad[date] ? weightData.dad[date] : null);
    momData.push(weightData.mom && weightData.mom[date] ? weightData.mom[date] : null);
    meData.push(weightData.me && weightData.me[date] ? weightData.me[date] : null);
  });
  
  const option = {
    animation: false,
    tooltip: {
      trigger: 'axis'
    },
    legend: {
      data: ['爸爸', '妈妈', '我']
    },
    grid: {
      left: '3%',
      right: '4%',
      bottom: '3%',
      containLabel: true
    },
    xAxis: {
      type: 'category',
      boundaryGap: false,
      data: sortedDates.map(d => d.substring(5)) // 显示月-日
    },
    yAxis: {
      type: 'value',
      name: '体重 (kg)'
    },
    series: [
      {
        name: '爸爸',
        type: 'line',
        data: dadData,
        itemStyle: {
          color: '#FFB26B'
        }
      },
      {
        name: '妈妈',
        type: 'line',
        data: momData,
        itemStyle: {
          color: '#FFD4D4'
        }
      },
      {
        name: '我',
        type: 'line',
        data: meData,
        itemStyle: {
          color: '#4A4A4A'
        }
      }
    ]
  };
  
  weightChart.setOption(option);
}

// 模态框控制
function setupModals() {
  const modals = document.querySelectorAll('.modal');
  const closeButtons = document.querySelectorAll('.close');
  
  // 打开位置模态框
  document.getElementById('addLocationBtn').addEventListener('click', function() {
    document.getElementById('locationModal').style.display = 'block';
    document.getElementById('modalLocationDate').value = new Date().toISOString().split('T')[0];
  });
  
  // 打开血糖模态框
  document.getElementById('addGlucoseBtn').addEventListener('click', function() {
    document.getElementById('glucoseModal').style.display = 'block';
    document.getElementById('modalGlucoseDate').value = new Date().toISOString().split('T')[0];
  });
  
  // 打开体重模态框
  document.querySelectorAll('.edit-weight').forEach(button => {
    button.addEventListener('click', function() {
      document.getElementById('weightModal').style.display = 'block';
      document.getElementById('modalWeightMember').value = this.getAttribute('data-member');
      document.getElementById('modalWeightDate').value = new Date().toISOString().split('T')[0];
    });
  });
  
  // 关闭模态框
  closeButtons.forEach(button => {
    button.addEventListener('click', function() {
      modals.forEach(modal => {
        modal.style.display = 'none';
      });
    });
  });
  
  // 点击模态框外部关闭
  window.addEventListener('click', function(event) {
    modals.forEach(modal => {
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    });
  });
  
  // 表单提交处理
  document.getElementById('locationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const date = document.getElementById('modalLocationDate').value;
    const location = document.getElementById('modalLocation').value;
    
    // 显示加载状态
    document.getElementById('locationLoading').classList.remove('hidden');
    document.getElementById('locationSubmitText').classList.add('hidden');
    
    // 保存到Firestore
    db.collection("locations").add({
      date: date,
      location: location
    })
    .then(() => {
      document.getElementById('locationModal').style.display = 'none';
      this.reset();
    })
    .catch((error) => {
      console.error("保存位置数据错误:", error);
      showConnectionStatus(false);
    })
    .finally(() => {
      document.getElementById('locationLoading').classList.add('hidden');
      document.getElementById('locationSubmitText').classList.remove('hidden');
    });
  });
  
  document.getElementById('glucoseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const date = document.getElementById('modalGlucoseDate').value;
    const fasting = document.getElementById('fastingGlucose').value || null;
    const beforeBreakfast = document.getElementById('beforeBreakfast').value || null;
    const afterBreakfast = document.getElementById('afterBreakfast').value || null;
    const beforeLunch = document.getElementById('beforeLunch').value || null;
    const afterLunch = document.getElementById('afterLunch').value || null;
    const beforeDinner = document.getElementById('beforeDinner').value || null;
    const afterDinner = document.getElementById('afterDinner').value || null;
    
    // 显示加载状态
    document.getElementById('glucoseLoading').classList.remove('hidden');
    document.getElementById('glucoseSubmitText').classList.add('hidden');
    
    // 保存到Firestore
    db.collection("glucose").add({
      date: date,
      fasting: fasting ? parseFloat(fasting) : null,
      beforeBreakfast: beforeBreakfast ? parseFloat(beforeBreakfast) : null,
      afterBreakfast: afterBreakfast ? parseFloat(afterBreakfast) : null,
      beforeLunch: beforeLunch ? parseFloat(beforeLunch) : null,
      afterLunch: afterLunch ? parseFloat(afterLunch) : null,
      beforeDinner: beforeDinner ? parseFloat(beforeDinner) : null,
      afterDinner: afterDinner ? parseFloat(afterDinner) : null
    })
    .then(() => {
      document.getElementById('glucoseModal').style.display = 'none';
      this.reset();
    })
    .catch((error) => {
      console.error("保存血糖数据错误:", error);
      showConnectionStatus(false);
    })
    .finally(() => {
      document.getElementById('glucoseLoading').classList.add('hidden');
      document.getElementById('glucoseSubmitText').classList.remove('hidden');
    });
  });
  
  document.getElementById('weightForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const member = document.getElementById('modalWeightMember').value;
    const date = document.getElementById('modalWeightDate').value;
    const weight = parseFloat(document.getElementById('modalWeight').value);
    
    // 显示加载状态
    document.getElementById('weightLoading').classList.remove('hidden');
    document.getElementById('weightSubmitText').classList.add('hidden');
    
    // 保存到Firestore
    db.collection("weights").add({
      member: member,
      date: date,
      weight: weight
    })
    .then(() => {
      document.getElementById('weightModal').style.display = 'none';
      this.reset();
    })
    .catch((error) => {
      console.error("保存体重数据错误:", error);
      showConnectionStatus(false);
    })
    .finally(() => {
      document.getElementById('weightLoading').classList.add('hidden');
      document.getElementById('weightSubmitText').classList.remove('hidden');
    });
  });
}

// 初始化
function init() {
  setupModals();
  
  // 设置日期输入默认值为今天
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('locationDate').value = today;
  document.getElementById('glucoseDate').value = today;
  
  // 加载数据
  loadData();
  
  // 监听窗口大小变化，重新渲染图表
  window.addEventListener('resize', function() {
    glucoseChart.resize();
    weightChart.resize();
    locationStatsChart.resize();
  });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
